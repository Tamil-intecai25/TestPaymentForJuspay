<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Status</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #0f172a;
        --card: rgba(30, 41, 59, 0.9);
        --success: #22c55e;
        --failed: #ef4444;
        --pending: #eab308;
        --border: rgba(255, 255, 255, 0.1);
      }

      * {
        font-family: "Outfit", sans-serif;
        box-sizing: border-box;
      }

      body {
        background: var(--bg);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .card {
        background: var(--card);
        padding: 50px;
        border-radius: 24px;
        border: 1px solid var(--border);
        text-align: center;
        width: 100%;
        max-width: 420px;
      }

      h1 {
        margin-bottom: 10px;
        font-size: 26px;
      }

      .message {
        font-size: 18px;
        font-weight: 600;
        margin-top: 20px;
      }

      .success {
        color: var(--success);
      }

      .failed {
        color: var(--failed);
      }

      .pending {
        color: var(--pending);
      }

      .spinner {
        width: 28px;
        height: 28px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>Payment Status</h1>
      <div id="spinner" class="spinner"></div>
      <div id="message" class="message pending">Verifying payment...</div>
    </div>

    <script>
      const message = document.getElementById("message");
      const spinner = document.getElementById("spinner");

      let poller = null;
      const POLL_TIME = 3000;

      function getOrderIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("order_id");
      }

      async function checkPayment(orderId) {
        try {
          const res = await fetch(
            `https://one-app-payment-service.mergit.in/payment/verify-payment/${orderId}`
          );
          const json = await res.json();

          if (json.status !== "success") {
            throw new Error("Verification failed");
          }

          const status = json.data.paymentStatus.toUpperCase();

          if (["SUCCESS", "CHARGED", "COMPLETED"].includes(status)) {
            showSuccess();
            stopPolling();
          } else if (["FAILED", "CANCELLED", "ERROR"].includes(status)) {
            showFailed();
            stopPolling();
          }
        } catch (err) {
          showFailed();
          stopPolling();
        }
      }

      function showSuccess() {
        spinner.style.display = "none";
        message.textContent = "✅ Payment Successful";
        message.className = "message success";
      }

      function showFailed() {
        spinner.style.display = "none";
        message.textContent = "❌ Payment Failed";
        message.className = "message failed";
      }

      function startPolling(orderId) {
        checkPayment(orderId);
        poller = setInterval(() => checkPayment(orderId), POLL_TIME);
      }

      function stopPolling() {
        if (poller) clearInterval(poller);
      }

      window.onload = () => {
        const orderId = getOrderIdFromURL();

        if (!orderId) {
          spinner.style.display = "none";
          message.textContent = "Invalid payment reference";
          message.className = "message failed";
          return;
        }

        startPolling(orderId);
      };
    </script>
  </body>
</html>
